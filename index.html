<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomLedger - Smart Debt Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 RoomLedger</h1>
            <p>Smart debt tracking for families & roommates</p>
            <div style="margin-top: var(--space-4); display: flex; justify-content: center; gap: var(--space-2);">
                <span style="background: rgba(52, 199, 89, 0.1); color: var(--apple-green); padding: var(--space-1) var(--space-3); border-radius: var(--radius-full); font-size: 12px; font-weight: 600;">✨ Smart Settlement</span>
                <span style="background: rgba(0, 122, 255, 0.1); color: var(--apple-blue); padding: var(--space-1) var(--space-3); border-radius: var(--radius-full); font-size: 12px; font-weight: 600;">👥 Group Management</span>
                <span style="background: rgba(255, 149, 0, 0.1); color: var(--apple-orange); padding: var(--space-1) var(--space-3); border-radius: var(--radius-full); font-size: 12px; font-weight: 600;">📱 Mobile Friendly</span>
            </div>
        </div>

        <!-- Auth Section -->
        <div id="authSection" class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>🔐</span>
                    Welcome to RoomLedger
                </div>
                <div class="card-subtitle">Track expenses and settle debts with your roommates</div>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showAuthTab('login')">
                    <span>👤</span>
                    Login
                </button>
                <button class="tab-btn" onclick="showAuthTab('register')">
                    <span>🏠</span>
                    Create Group
                </button>
            </div>

            <!-- Login Tab -->
            <div id="loginTab" class="tab-content active">
                <div class="auth-section">
                    <div class="auth-icon">👤</div>
                    <h3>Login to Your Group</h3>
                    <p class="auth-description">Enter your credentials to access your expense tracking group</p>
                    
                    <div class="form-group">
                        <label>Your Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username">
                        <small class="form-hint">The username you used when creating the group</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Group Password</label>
                        <form onsubmit="event.preventDefault(); login();">
                            <input type="password" id="loginPassword" placeholder="Enter group password" autocomplete="current-password">
                        </form>
                        <small class="form-hint">The password shared with your group members</small>
                    </div>
                    
                    <button class="btn btn-primary btn-large" onclick="login()">
                        <span>🔓</span>
                        Login to Group
                    </button>
                    
                    <div id="loginError" class="message error"></div>
                </div>
            </div>

            <!-- Register Tab -->
            <div id="registerTab" class="tab-content">
                <div class="auth-section">
                    <div class="auth-icon">🏠</div>
                    <h3>Create New Group</h3>
                    <p class="auth-description">Set up your expense tracking group and invite your roommates</p>
                    
                    <!-- Step 1: Admin Info -->
                    <div class="setup-step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">🛠️ Group Setup</div>
                        </div>
                        <p class="step-description">Name your room, create the admin account, and choose the default currency</p>

                        <div class="form-group">
                            <label>Group Name</label>
                            <input type="text" id="groupName" placeholder="e.g., Room 101 or Karachi Apartment">
                            <small class="form-hint">This name helps everyone recognize the shared space</small>
                        </div>

                        <div class="form-group">
                            <label>Your Name (Group Admin)</label>
                            <input type="text" id="adminName" placeholder="Enter your full name">
                            <small class="form-hint">This will be your display name in the group</small>
                        </div>

                        <div class="form-group">
                            <label>Group Password</label>
                            <form onsubmit="event.preventDefault(); createGroup();">
                                <input type="password" id="groupPassword" placeholder="Create a secure password for your group" autocomplete="new-password">
                            </form>
                            <small class="form-hint">
                                <span style="color: var(--apple-orange);">🔒</span>
                                This password will be shared with all group members
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Default Currency</label>
                            <select id="groupCurrency">
                                <option value="PKR" selected>PKR — Pakistani Rupee</option>
                                <option value="USD">USD — US Dollar</option>
                                <option value="EUR">EUR — Euro</option>
                                <option value="GBP">GBP — British Pound</option>
                                <option value="AED">AED — UAE Dirham</option>
                                <option value="INR">INR — Indian Rupee</option>
                                <option value="AUD">AUD — Australian Dollar</option>
                                <option value="CAD">CAD — Canadian Dollar</option>
                                <option value="SAR">SAR — Saudi Riyal</option>
                            </select>
                            <small class="form-hint">You can update this later from the group settings</small>
                        </div>
                    </div>
                
                    <!-- Step 2: Add Members -->
                    <div class="setup-step">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">👥 Add Group Members</div>
                        </div>
                        <p class="step-description">Invite your roommates to join the expense tracking group</p>
                        
                        <div class="member-counter">
                            <div class="counter-badge">
                                <span class="member-count">1</span>
                                <span class="counter-label">member</span>
                            </div>
                            <span class="counter-note">(including you)</span>
                        </div>
                        
                        <div class="member-input-section">
                            <div class="form-group">
                                <label>Member Name</label>
                                <div class="input-with-button">
                                    <input type="text" id="memberName" placeholder="Enter member name" onkeypress="handleMemberKeyPress(event)">
                                    <button class="btn btn-secondary btn-add" onclick="addMember()">
                                        <span>➕</span>
                                        Add
                                    </button>
                                </div>
                                <small class="form-hint">Press Enter to quickly add members</small>
                            </div>
                        </div>
                        
                        <div id="membersList" class="member-list"></div>
                        
                        <div class="tips-card">
                            <div class="tips-header">
                                <span class="tips-icon">💡</span>
                                <strong>Quick Tips</strong>
                            </div>
                            <ul class="tips-list">
                                <li>Press <strong>Enter</strong> to quickly add members</li>
                                <li>Add at least 2-3 members for better expense tracking</li>
                                <li>You can add more members after creating the group</li>
                            </ul>
                        </div>
                    </div>
                
                    <!-- Step 3: Create Group -->
                    <div class="create-group-section">
                        <div class="create-group-card">
                            <div class="create-group-icon">🚀</div>
                            <h4>Ready to Start Tracking?</h4>
                            <p>Your group will be created and you can start adding expenses immediately</p>
                            
                            <button class="btn btn-primary btn-large btn-create" onclick="createGroup()">
                                <span>🚀</span>
                                Create Group & Start Tracking
                            </button>
                            
                            <div id="registerError" class="message error"></div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="appSection" class="hidden" style="display: none;">
            <div class="card">
                <div class="app-header">
                    <div class="welcome-section">
                        <h2 id="welcomeMessage">Welcome!</h2>
                        <p class="app-subtitle">Track expenses and settle debts with your roommates</p>
                    </div>
                    <button class="btn btn-secondary btn-logout" onclick="logout()">
                        <span>🚪</span>
                        Logout
                    </button>
                </div>
                
                <!-- Debug info -->
                <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
                    <strong>Debug Info:</strong><br>
                    Current User: <span id="debugUser">Loading...</span><br>
                    Current Group: <span id="debugGroup">Loading...</span><br>
                    Group Members: <span id="debugMembers">Loading...</span><br>
                    Supabase Status: <span id="debugSupabase">Loading...</span>
                </div>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('dashboard')">
                        <span>📊</span>
                        Dashboard
                    </button>
                    <button class="tab-btn" onclick="showTab('addDebt')">
                        <span>➕</span>
                        Add Expense
                    </button>
                    <button class="tab-btn" onclick="showTab('settle')">
                        <span>💰</span>
                        Settle All
                    </button>
                    <button class="tab-btn" onclick="showTab('history')">
                        <span>📜</span>
                        History
                    </button>
                    <button class="tab-btn" onclick="showTab('manage')">
                        <span>👥</span>
                        Manage Group
                    </button>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content active">
                    <div class="card-header">
                        <div class="card-title">
                            <span>📊</span>
                            Dashboard Overview
                        </div>
                        <div class="card-subtitle">Quick overview of your group's financial status</div>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">💰</div>
                            <div class="stat-value" id="totalExpenses">PKR 0</div>
                            <div class="stat-label">Total Expenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-value" id="memberCount">0</div>
                            <div class="stat-label">Group Members</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📈</div>
                            <div class="stat-value" id="pendingSettlements">0</div>
                            <div class="stat-label">Pending Settlements</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-value" id="completedSettlements">0</div>
                            <div class="stat-label">Completed Settlements</div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h3>Quick Actions</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showTab('addDebt')">
                                <span>➕</span>
                                Add New Expense
                            </button>
                            <button class="btn btn-secondary" onclick="showTab('settle')">
                                <span>💰</span>
                                View Settlements
                            </button>
                            <button class="btn btn-secondary" onclick="showTab('history')">
                                <span>📜</span>
                                View History
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <h3>Recent Activity</h3>
                        <div id="recentActivityList" class="activity-list">
                            <div class="activity-item">
                                <div class="activity-icon">📊</div>
                                <div class="activity-content">
                                    <div class="activity-title">Dashboard loaded</div>
                                    <div class="activity-time">Just now</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Balances Preview -->
                    <div class="balances-preview">
                        <h3>Current Balances</h3>
                        <div id="balancesPreview" class="balances-list">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Add Debt Tab -->
                <div id="addDebtTab" class="tab-content">
                    <div class="card-header">
                        <div class="card-title">
                            <span>➕</span>
                            Add New Expense
                        </div>
                        <div class="card-subtitle">Record shared expenses and track who owes what</div>
                    </div>
                    
                    <div class="expense-form">
                        <div class="form-group">
                            <label>Expense Description</label>
                            <input type="text" id="debtDescription" placeholder="e.g., Dinner at restaurant, Uber ride, Groceries">
                            <small class="form-hint">Describe what the expense was for</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Category</label>
                            <div class="category-selector">
                                <div class="category-option" data-category="food">
                                    <span class="category-icon">🍕</span>
                                    <span class="category-name">Food & Dining</span>
                                </div>
                                <div class="category-option" data-category="transport">
                                    <span class="category-icon">🚗</span>
                                    <span class="category-name">Transport</span>
                                </div>
                                <div class="category-option" data-category="utilities">
                                    <span class="category-icon">⚡</span>
                                    <span class="category-name">Utilities</span>
                                </div>
                                <div class="category-option" data-category="entertainment">
                                    <span class="category-icon">🎬</span>
                                    <span class="category-name">Entertainment</span>
                                </div>
                                <div class="category-option" data-category="shopping">
                                    <span class="category-icon">🛒</span>
                                    <span class="category-name">Shopping</span>
                                </div>
                                <div class="category-option" data-category="other">
                                    <span class="category-icon">📦</span>
                                    <span class="category-name">Other</span>
                                </div>
                            </div>
                            <input type="hidden" id="expenseCategory" value="food">
                        </div>
                        
                        <div class="form-group">
                            <label>Who Paid?</label>
                            <select id="whoPaid"></select>
                            <small class="form-hint">Select who covered this expense</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Amount (<span id="amountCurrencyLabel">PKR</span>)</label>
                            <div class="amount-input">
                                <input type="number" id="debtAmount" placeholder="Enter amount" step="0.01" min="0">
                                <div class="currency-symbol" id="amountCurrencySymbol">PKR</div>
                            </div>
                            <small class="form-hint">Total amount that was paid</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Split Between</label>
                            <div class="split-description">Select all members who should contribute to this expense</div>
                            <div id="splitBetween" class="checkbox-group"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method (Optional)</label>
                            <select id="paymentMethod">
                                <option value="">Select payment method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="mobile">Mobile Payment</option>
                            </select>
                            <small class="form-hint">How was this expense paid?</small>
                        </div>
                        
                        <button class="btn btn-primary btn-large" onclick="addDebt()">
                            <span>➕</span>
                            Add Expense
                        </button>
                        
                        <div id="debtError" class="message error"></div>
                        <div id="debtSuccess" class="message success"></div>
                    </div>
                </div>

                <!-- Settle Tab -->
                <div id="settleTab" class="tab-content">
                    <div class="card-header">
                        <div class="card-title">
                            <span>💰</span>
                            Current Balances & Smart Settlement
                        </div>
                        <div class="card-subtitle">See who owes what to whom and settle efficiently</div>
                    </div>
                    
                    <!-- Enhanced Debt Summary -->
                    <div class="debt-summary">
                        <div class="debt-summary-header">
                            <div class="debt-summary-title">Group Overview</div>
                            <div class="debt-summary-amount" id="totalDebtAmount">PKR 0.00</div>
                        </div>
                        <div class="debt-breakdown" id="currentBalances"></div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="calculateSettlement()">
                        <span>🧮</span>
                        Calculate Smart Settlement
                    </button>
                    
                    <div id="settlementResult"></div>
                    <div id="settleActions" class="hidden" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="executeSettlement()">
                            <span>✅</span>
                            Confirm & Record Settlement
                        </button>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="historyTab" class="tab-content">
                    <div class="card-header">
                        <div class="card-title">
                            <span>📜</span>
                            Settlement History
                        </div>
                        <div class="card-subtitle">View past settlements and payment records</div>
                    </div>
                    
                    <div class="history-content">
                        <div id="historyList"></div>
                    </div>
                </div>

                <!-- Manage Group Tab -->
                <div id="manageTab" class="tab-content">
                    <div class="card-header">
                        <div class="card-title">
                            <span>👥</span>
                            Manage Group Members
                        </div>
                        <div class="card-subtitle">Add new members and manage existing ones</div>
                    </div>

                    <!-- Group Settings Section -->
                    <div class="manage-section">
                        <div class="section-header">
                            <div class="section-icon">⚙️</div>
                            <div class="section-title">Group Settings</div>
                        </div>
                        <p class="section-description">Update the shared room name and default currency for this group</p>

                        <div id="groupSettingsAdminNote" class="info hidden">Only group admins can update these settings.</div>

                        <div class="form-group">
                            <label>Group Name</label>
                            <input type="text" id="groupNameInput" placeholder="e.g., Room 101 or Beach Apartment">
                        </div>

                        <div class="form-group">
                            <label>Default Currency</label>
                            <select id="groupCurrencySelect">
                                <option value="PKR" selected>PKR — Pakistani Rupee</option>
                                <option value="USD">USD — US Dollar</option>
                                <option value="EUR">EUR — Euro</option>
                                <option value="GBP">GBP — British Pound</option>
                                <option value="AED">AED — UAE Dirham</option>
                                <option value="INR">INR — Indian Rupee</option>
                                <option value="AUD">AUD — Australian Dollar</option>
                                <option value="CAD">CAD — Canadian Dollar</option>
                                <option value="SAR">SAR — Saudi Riyal</option>
                            </select>
                            <small class="form-hint">All totals and settlements will use this currency</small>
                        </div>

                        <button class="btn btn-primary" id="saveGroupSettingsBtn" onclick="saveGroupSettings()">
                            <span>💾</span>
                            Save Settings
                        </button>

                        <div id="settingsError" class="message error"></div>
                        <div id="settingsSuccess" class="message success"></div>
                    </div>

                    <!-- Add New Member Section -->
                    <div class="manage-section">
                        <div class="section-header">
                            <div class="section-icon">➕</div>
                            <div class="section-title">Add New Member</div>
                        </div>
                        <p class="section-description">Invite new members to join your expense tracking group</p>
                        
                        <div class="add-member-form">
                            <div class="form-group">
                                <label>New Member Name</label>
                                <div class="input-with-button">
                                    <input type="text" id="newMemberName" placeholder="Enter member name">
                                    <button class="btn btn-secondary btn-add" onclick="addNewMember()">
                                        <span>➕</span>
                                        Add
                                    </button>
                                </div>
                                <small class="form-hint">New members can login with the group password</small>
                            </div>
                        </div>
                        
                        <div id="manageError" class="message error"></div>
                        <div id="manageSuccess" class="message success"></div>
                    </div>
                    
                    <!-- Current Members Section -->
                    <div class="manage-section">
                        <div class="section-header">
                            <div class="section-icon">👥</div>
                            <div class="section-title">Current Members</div>
                        </div>
                        <p class="section-description">Manage existing group members. Only admins can remove members</p>
                        
                        <div class="members-list" id="currentMembers"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase - Will be loaded securely from server
        let SUPABASE_URL = null;
        let SUPABASE_ANON_KEY = null;
        
        // Load Supabase credentials securely from server
        async function loadSupabaseConfig() {
            const endpoints = [
                '/api/get-config',
                '/.netlify/functions/get-config'
            ];

            let lastError = null;

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, { cache: 'no-store' });
                    if (!response.ok) {
                        lastError = new Error(`${endpoint} responded with status ${response.status}`);
                        continue;
                    }

                    const config = await response.json();
                    SUPABASE_URL = config.supabaseUrl;
                    SUPABASE_ANON_KEY = config.supabaseAnonKey;

                    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                        lastError = new Error(`Supabase credentials missing from ${endpoint}`);
                        continue;
                    }

                    // Initialize Supabase client
                    initializeSupabase();
                    return;
                } catch (error) {
                    lastError = error;
                }
            }

            console.error('⚠️ Failed to load Supabase configuration.', lastError);
            console.info('Hosting on Vercel? Set SUPABASE_URL and SUPABASE_ANON_KEY under Project Settings → Environment Variables, then redeploy.');
            console.info('Hosting on Netlify? Set SUPABASE_URL and SUPABASE_ANON_KEY under Site Settings → Build & deploy → Environment, then trigger a new deploy.');
            
            // Show error to user
            showConfigError();
        }
        
        function showConfigError() {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = 'Configuration error: Please check console for details.';
                errorDiv.style.display = 'block';
            }
        }
        
        // Initialize Supabase client
        function initializeSupabase() {
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase client not loaded. Please check the CDN link.');
                return;
            }
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase client initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Supabase client:', error);
            }
        }
        
        // Initialize Supabase client with error handling
        let supabase;
        
        // Load configuration and initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSupabaseConfig();
        });

        // Global variables - Initialize immediately
        let currentUser = null;
        let currentGroup = null;
        let groupMembers = [];
        let pendingMembers = [];
        let currentSettlement = null;

        const DEFAULT_CURRENCY = 'PKR';

        function getCurrentCurrency() {
            if (currentGroup && currentGroup.currency) {
                return currentGroup.currency;
            }
            return DEFAULT_CURRENCY;
        }

        function formatCurrency(amount, currencyOverride) {
            const value = Number.isFinite(amount) ? amount : parseFloat(amount);
            const safeValue = Number.isFinite(value) ? value : 0;
            const currency = currencyOverride || getCurrentCurrency();

            try {
                return new Intl.NumberFormat(undefined, {
                    style: 'currency',
                    currency,
                    currencyDisplay: 'symbol',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(safeValue);
            } catch (error) {
                return `${currency} ${safeValue.toFixed(2)}`;
            }
        }

        function getCurrencySymbol(currencyOverride) {
            const currency = currencyOverride || getCurrentCurrency();

            try {
                const formatted = new Intl.NumberFormat(undefined, {
                    style: 'currency',
                    currency,
                    currencyDisplay: 'narrowSymbol',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(0);

                const symbol = formatted.replace(/[\d\s.,]/g, '').trim();
                return symbol || currency;
            } catch (error) {
                return currency;
            }
        }

        function updateCurrencyDisplay() {
            const currencyCode = getCurrentCurrency();
            const currencySymbol = getCurrencySymbol(currencyCode);

            const label = document.getElementById('amountCurrencyLabel');
            if (label) {
                label.textContent = currencyCode;
            }

            const symbolElement = document.getElementById('amountCurrencySymbol');
            if (symbolElement) {
                symbolElement.textContent = currencySymbol;
            }

            const totalExpensesElement = document.getElementById('totalExpenses');
            if (totalExpensesElement) {
                if (typeof totalExpensesElement.dataset.value === 'undefined') {
                    totalExpensesElement.dataset.value = 0;
                }
                const rawValue = parseFloat(totalExpensesElement.dataset.value || 0);
                totalExpensesElement.textContent = formatCurrency(rawValue, currencyCode);
            }

            const totalDebtElement = document.getElementById('totalDebtAmount');
            if (totalDebtElement) {
                if (typeof totalDebtElement.dataset.value === 'undefined') {
                    totalDebtElement.dataset.value = 0;
                }
                const rawDebt = parseFloat(totalDebtElement.dataset.value || 0);
                totalDebtElement.textContent = formatCurrency(rawDebt, currencyCode);
            }

            const subtitle = document.querySelector('.app-subtitle');
            if (subtitle) {
                const groupName = currentGroup && currentGroup.name ? currentGroup.name : 'Shared expenses';
                subtitle.textContent = `${groupName} • Currency: ${currencyCode}`;
            }
        }

        // Auth functions
        function showAuthTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        function handleMemberKeyPress(event) {
            if (event.key === 'Enter') {
                addMember();
            }
        }

        function addMember() {
            const memberName = document.getElementById('memberName').value.trim();
            const errorDiv = document.getElementById('registerError');
            
            if (!memberName) {
                errorDiv.textContent = 'Please enter a member name';
                return;
            }
            
            if (memberName.length < 2) {
                errorDiv.textContent = 'Member name must be at least 2 characters long';
                return;
            }
            
            if (pendingMembers.includes(memberName)) {
                errorDiv.textContent = 'This member is already in the list';
                return;
            }
            
            // Check if it's the same as admin name
            const adminName = document.getElementById('adminName').value.trim();
            if (memberName.toLowerCase() === adminName.toLowerCase()) {
                errorDiv.textContent = 'Member name cannot be the same as admin name';
                return;
            }
            
            pendingMembers.push(memberName);
            updateMembersList();
            document.getElementById('memberName').value = '';
            errorDiv.textContent = '';
            
            // Show success feedback
            const successFeedback = document.createElement('div');
            successFeedback.className = 'success';
            successFeedback.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <span>✅</span>
                    <span><strong>${memberName}</strong> added to the group</span>
                </div>
            `;
            successFeedback.style.marginTop = 'var(--space-2)';
            document.getElementById('membersList').appendChild(successFeedback);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                successFeedback.remove();
            }, 3000);
            
            // Update the member count display
            updateMemberCount();
        }
        
        function updateMemberCount() {
            const totalMembers = pendingMembers.length + 1; // +1 for admin
            const countDisplay = document.querySelector('.member-count');
            const labelDisplay = document.querySelector('.counter-label');

            if (countDisplay) {
                countDisplay.textContent = totalMembers;
            }

            if (labelDisplay) {
                labelDisplay.textContent = totalMembers === 1 ? 'member' : 'members';
            }
        }

        function removeMember(name) {
            pendingMembers = pendingMembers.filter(member => member !== name);
            updateMembersList();
        }

        function updateMembersList() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = pendingMembers.map(member =>
                `<div class="member-chip">
                    ${member}
                    <button class="remove-member" onclick="removeMember('${member}')">×</button>
                </div>`
            ).join('');

            updateMemberCount();
        }

        async function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const adminName = document.getElementById('adminName').value.trim();
            const password = document.getElementById('groupPassword').value.trim();
            const currency = document.getElementById('groupCurrency').value;
            const errorDiv = document.getElementById('registerError');

            if (!groupName || !adminName || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                return;
            }

            if (groupName.length < 2) {
                errorDiv.textContent = 'Group name must be at least 2 characters long';
                return;
            }

            if (pendingMembers.length === 0) {
                errorDiv.textContent = 'Please add at least one group member';
                return;
            }

            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                // Create group
                const { data: groupData, error: groupError } = await supabase
                    .from('groups')
                    .insert([{ name: groupName, password: password, currency: currency }])
                    .select();

                if (groupError) throw groupError;

                const groupId = groupData[0].id;

                // Add admin and members
                const allMembers = [adminName, ...pendingMembers];
                const memberInserts = allMembers.map((name, index) => ({
                    group_id: groupId,
                    username: name,
                    is_admin: index === 0
                }));

                const { error: membersError } = await supabase
                    .from('group_members')
                    .insert(memberInserts);

                if (membersError) throw membersError;

                errorDiv.textContent = '';
                alert('Group created successfully! You can now login.');
                showAuthTab('login');
                
                // Clear form
                document.getElementById('groupName').value = '';
                document.getElementById('adminName').value = '';
                document.getElementById('groupPassword').value = '';
                document.getElementById('groupCurrency').value = 'PKR';
                pendingMembers = [];
                updateMembersList();

            } catch (error) {
                errorDiv.textContent = 'Error creating group: ' + error.message;
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                return;
            }

            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized. Please refresh the page and try again.');
                }
                
                console.log('Attempting login for user:', username);
                
                // Find user and validate group password
                const { data: userData, error: userError } = await supabase
                    .from('group_members')
                    .select(`
                        *,
                        groups!inner(*)
                    `)
                    .eq('username', username)
                    .single();

                if (userError || !userData) {
                    console.error('User lookup error:', userError);
                    errorDiv.textContent = 'User not found';
                    return;
                }

                if (userData.groups.password !== password) {
                    errorDiv.textContent = 'Incorrect password';
                    return;
                }

                // Get all group members
                const { data: membersData, error: membersError } = await supabase
                    .from('group_members')
                    .select('*')
                    .eq('group_id', userData.group_id);

                if (membersError) {
                    console.error('Members lookup error:', membersError);
                    throw membersError;
                }

                currentUser = userData;
                currentGroup = userData.groups;
                groupMembers = membersData;

                console.log('Login successful, showing app...');
                showApp();
                errorDiv.textContent = '';
                
                // Fallback: ensure app section is visible after a short delay
                setTimeout(() => {
                    const appSection = document.getElementById('appSection');
                    if (appSection && appSection.classList.contains('hidden')) {
                        console.log('Fallback: forcing app section to show');
                        appSection.classList.remove('hidden');
                        appSection.style.display = 'block';
                    }
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Login error: ' + error.message;
            }
        }

        function logout() {
            currentUser = null;
            currentGroup = null;
            groupMembers = [];
            
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
            
            // Clear form fields
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showApp() {
            console.log('showApp() called');
            
            try {
                // Inject runtime CSS override to guarantee visibility
                const existingOverride = document.getElementById('app-visibility-override');
                if (!existingOverride) {
                    const style = document.createElement('style');
                    style.id = 'app-visibility-override';
                    style.textContent = `
                        #appSection { display: block !important; visibility: visible !important; opacity: 1 !important; }
                        #appSection .card { display: block !important; visibility: visible !important; opacity: 1 !important; }
                        #appSection .tab-content { display: none; }
                        #appSection .tab-content.active { display: block !important; }
                    `;
                    document.head.appendChild(style);
                }

                // Hide landing header
                const header = document.querySelector('.header');
                if (header) {
                    header.style.display = 'none';
                }

                // Hide auth section and show app section
                const authSection = document.getElementById('authSection');
                const appSection = document.getElementById('appSection');
                
                if (authSection) {
                    authSection.classList.add('hidden');
                    authSection.style.display = 'none';
                }
                if (appSection) {
                    appSection.classList.remove('hidden');
                    appSection.style.display = 'block';
                    appSection.style.visibility = 'visible';
                    appSection.style.opacity = '1';
                }
                
                console.log('Auth section hidden, app section shown');

                // Update welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (welcomeMessage && currentUser) {
                    welcomeMessage.textContent = `Welcome, ${currentUser.username}!`;
                }
                
                // Update debug info
                const debugUser = document.getElementById('debugUser');
                const debugGroup = document.getElementById('debugGroup');
                const debugMembers = document.getElementById('debugMembers');
                const debugSupabase = document.getElementById('debugSupabase');
                
                if (debugUser) debugUser.textContent = currentUser ? currentUser.username : 'Not set';
                if (debugGroup) debugGroup.textContent = currentGroup ? currentGroup.name : 'Not set';
                if (debugMembers) debugMembers.textContent = groupMembers ? groupMembers.length : 'Not set';
                if (debugSupabase) debugSupabase.textContent = supabase ? 'Connected' : 'Not connected';

                // Force show dashboard tab content explicitly as a fallback
                const dashboardTab = document.getElementById('dashboardTab');
                if (dashboardTab) {
                    dashboardTab.classList.add('active');
                    dashboardTab.style.display = 'block';
                    dashboardTab.style.visibility = 'visible';
                    dashboardTab.style.opacity = '1';
                }
                const addDebtTab = document.getElementById('addDebtTab');
                if (addDebtTab) addDebtTab.style.display = 'none';
                const settleTab = document.getElementById('settleTab');
                if (settleTab) settleTab.style.display = 'none';
                const historyTab = document.getElementById('historyTab');
                if (historyTab) historyTab.style.display = 'none';
                const manageTab = document.getElementById('manageTab');
                if (manageTab) manageTab.style.display = 'none';

                // Ensure the wrapper card is visible
                const appCard = appSection ? appSection.querySelector('.card') : null;
                if (appCard) {
                    appCard.style.display = 'block';
                    appCard.style.visibility = 'visible';
                    appCard.style.opacity = '1';
                }

                // Scroll into view so user immediately sees the app
                if (appSection) {
                    appSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                // Initialize all app components
                updateCurrencyDisplay();
                updateDropdowns();
                loadDashboard();
                loadCurrentBalances();
                loadHistory();
                updateManageTab();
                
                // Initialize category selector
                initializeCategorySelector();
                
                console.log('App initialization complete');
                
            } catch (error) {
                console.error('Error in showApp():', error);
                alert('Error loading app: ' + error.message);
            }
        }

        // Main app functions
        function showTab(tab) {
            console.log('Switching to tab:', tab);
            
            try {
                // Remove active class from all tabs
                document.querySelectorAll('#appSection .tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('#appSection .tab-content').forEach(content => content.classList.remove('active'));
                
                const tabs = ['dashboard', 'addDebt', 'settle', 'history', 'manage'];
                const index = tabs.indexOf(tab);
                
                if (index === -1) {
                    console.error('Invalid tab:', tab);
                    return;
                }
                
                // Add active class to selected tab
                const tabButtons = document.querySelectorAll('#appSection .tab-btn');
                const tabContent = document.getElementById(tab + 'Tab');
                
                if (tabButtons[index]) {
                    tabButtons[index].classList.add('active');
                } else {
                    console.error('Tab button not found for index:', index);
                }
                
                if (tabContent) {
                    tabContent.classList.add('active');
                } else {
                    console.error('Tab content not found:', tab + 'Tab');
                }
                
                // Load tab-specific content
                if (tab === 'dashboard') {
                    loadDashboard();
                } else if (tab === 'settle') {
                    loadCurrentBalances();
                } else if (tab === 'history') {
                    loadHistory();
                } else if (tab === 'manage') {
                    updateManageTab();
                }
                
                console.log('Tab switched successfully to:', tab);
                
            } catch (error) {
                console.error('Error switching tab:', error);
            }
        }

        function updateDropdowns() {
            try {
                const whoPaidSelect = document.getElementById('whoPaid');
                const splitBetweenDiv = document.getElementById('splitBetween');
                
                if (!whoPaidSelect || !splitBetweenDiv) {
                    console.error('Required dropdown elements not found');
                    return;
                }
                
                if (!groupMembers || groupMembers.length === 0) {
                    console.log('No group members available for dropdowns');
                    return;
                }
                
                // Who paid dropdown
                whoPaidSelect.innerHTML = groupMembers.map(member => 
                    `<option value="${member.id}">${member.username}</option>`
                ).join('');
                
                // Split between checkboxes with improved styling
                splitBetweenDiv.innerHTML = groupMembers.map(member => 
                    `<div class="checkbox-item">
                        <input type="checkbox" value="${member.id}" checked>
                        <label>${member.username}</label>
                    </div>`
                ).join('');
                
                console.log('Dropdowns updated successfully');
                
            } catch (error) {
                console.error('Error updating dropdowns:', error);
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            console.log('Loading dashboard...');
            try {
                // Load statistics
                await loadDashboardStats();
                await loadRecentActivity();
                await loadBalancesPreview();
                console.log('Dashboard loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Show error in dashboard
                const recentActivityList = document.getElementById('recentActivityList');
                if (recentActivityList) {
                    recentActivityList.innerHTML = '<div class="activity-item"><div class="activity-content"><div class="activity-title">Error loading dashboard</div></div></div>';
                }
            }
        }
        
        async function loadDashboardStats() {
            try {
                if (!supabase || !currentGroup) {
                    console.log('Supabase or currentGroup not available for dashboard stats');
                    return;
                }
                
                // Get total expenses
                const { data: expenses, error: expensesError } = await supabase
                    .from('transactions')
                    .select('amount')
                    .eq('group_id', currentGroup.id);
                
                if (expensesError) {
                    console.error('Error fetching expenses:', expensesError);
                    throw expensesError;
                }
                
                const totalExpenses = expenses ? expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0) : 0;
                const totalExpensesElement = document.getElementById('totalExpenses');
                if (totalExpensesElement) {
                    totalExpensesElement.dataset.value = totalExpenses;
                    totalExpensesElement.textContent = formatCurrency(totalExpenses);
                }
                
                // Get member count
                const memberCountElement = document.getElementById('memberCount');
                if (memberCountElement) {
                    memberCountElement.textContent = groupMembers ? groupMembers.length : 0;
                }
                
                // Get settlement counts (placeholder for now)
                const pendingElement = document.getElementById('pendingSettlements');
                const completedElement = document.getElementById('completedSettlements');
                if (pendingElement) pendingElement.textContent = '0';
                if (completedElement) completedElement.textContent = '0';
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        async function loadRecentActivity() {
            try {
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('group_id', currentGroup.id)
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                const activityList = document.getElementById('recentActivityList');
                activityList.innerHTML = '';
                
                if (transactions.length === 0) {
                    activityList.innerHTML = '<div class="activity-item"><div class="activity-content"><div class="activity-title">No recent activity</div></div></div>';
                    return;
                }
                
                transactions.forEach(transaction => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    activityItem.innerHTML = `
                        <div class="activity-icon">💰</div>
                        <div class="activity-content">
                            <div class="activity-title">${transaction.description}</div>
                            <div class="activity-time">${new Date(transaction.created_at).toLocaleDateString()}</div>
                        </div>
                    `;
                    activityList.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }
        
        async function loadBalancesPreview() {
            try {
                const balances = await calculateBalances();
                const balancesPreview = document.getElementById('balancesPreview');
                balancesPreview.innerHTML = '';
                
                if (balances.length === 0) {
                    balancesPreview.innerHTML = '<div class="message info">Everyone is settled up!</div>';
                    return;
                }
                
                balances.slice(0, 3).forEach(balance => {
                    const balanceItem = document.createElement('div');
                    balanceItem.className = 'debt-item';
                    const formattedAmount = formatCurrency(balance.amount);
                    const displayAmount = balance.amount > 0 ? `+${formattedAmount}` : formattedAmount;
                    balanceItem.innerHTML = `
                        <div class="debt-name">${balance.name}</div>
                        <div class="debt-amount ${balance.amount >= 0 ? 'positive' : 'negative'}">
                            ${displayAmount}
                        </div>
                    `;
                    balancesPreview.appendChild(balanceItem);
                });
                
                if (balances.length > 3) {
                    const moreItem = document.createElement('div');
                    moreItem.className = 'message info';
                    moreItem.textContent = `And ${balances.length - 3} more...`;
                    balancesPreview.appendChild(moreItem);
                }
                
            } catch (error) {
                console.error('Error loading balances preview:', error);
            }
        }
        
        // Category selector functions
        function initializeCategorySelector() {
            const categoryOptions = document.querySelectorAll('.category-option');
            const categoryInput = document.getElementById('expenseCategory');
            
            categoryOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    categoryOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Update hidden input
                    categoryInput.value = option.dataset.category;
                });
            });
            
            // Set default selected category
            document.querySelector('[data-category="food"]').classList.add('selected');
        }
        
        // Helper function to calculate balances
        async function calculateBalances() {
            try {
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select(`
                        *,
                        from_member:group_members!from_member_id(username),
                        to_member:group_members!to_member_id(username)
                    `)
                    .eq('group_id', currentGroup.id)
                    .eq('settled', false);

                if (error) throw error;

                // Calculate net balances
                const balances = {};
                groupMembers.forEach(member => {
                    balances[member.id] = { name: member.username, amount: 0 };
                });

                transactions.forEach(transaction => {
                    balances[transaction.from_member_id].amount -= transaction.amount;
                    balances[transaction.to_member_id].amount += transaction.amount;
                });

                return Object.values(balances).filter(person => Math.abs(person.amount) > 0.01);
            } catch (error) {
                console.error('Error calculating balances:', error);
                return [];
            }
        }
        
        async function addDebt() {
            const description = document.getElementById('debtDescription').value.trim();
            const whoPaid = document.getElementById('whoPaid').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const splitBetween = Array.from(document.querySelectorAll('#splitBetween input:checked')).map(cb => parseInt(cb.value));
            const category = document.getElementById('expenseCategory').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const errorDiv = document.getElementById('debtError');
            const successDiv = document.getElementById('debtSuccess');
            
            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (!description || !amount || splitBetween.length === 0) {
                errorDiv.textContent = 'Please fill in all required fields and select at least one person to split between';
                return;
            }

            try {
                const perPersonAmount = amount / splitBetween.length;
                
                // Create transactions for each person who owes money
                const transactions = splitBetween
                    .filter(personId => personId !== parseInt(whoPaid))
                    .map(personId => ({
                        group_id: currentGroup.id,
                        description: description,
                        from_member_id: personId,
                        to_member_id: parseInt(whoPaid),
                        amount: perPersonAmount,
                        created_by: currentUser.id
                    }));

                if (transactions.length > 0) {
                    const { error } = await supabase
                        .from('transactions')
                        .insert(transactions);

                    if (error) throw error;
                }

                successDiv.textContent = 'Expense added successfully!';
                
                // Clear form
                document.getElementById('debtDescription').value = '';
                document.getElementById('debtAmount').value = '';
                
                // Refresh views so dashboards stay in sync
                loadDashboard();
                loadCurrentBalances();

            } catch (error) {
                errorDiv.textContent = 'Error adding expense: ' + error.message;
            }
        }

        async function loadCurrentBalances() {
            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }

                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select(`
                        *,
                        from_member:group_members!from_member_id(username),
                        to_member:group_members!to_member_id(username)
                    `)
                    .eq('group_id', currentGroup.id)
                    .eq('settled', false);

                if (error) throw error;

                const balances = {};
                groupMembers.forEach(member => {
                    balances[member.id] = { name: member.username, balance: 0 };
                });

                transactions.forEach(transaction => {
                    balances[transaction.from_member_id].balance -= transaction.amount;
                    balances[transaction.to_member_id].balance += transaction.amount;
                });

                const balancesDiv = document.getElementById('currentBalances');
                const totalDebtAmountElement = document.getElementById('totalDebtAmount');

                const balanceItems = Object.values(balances)
                    .filter(person => Math.abs(person.balance) > 0.01)
                    .map(person => {
                        const isPositive = person.balance > 0;
                        const status = isPositive ? 'owed-to' : 'owed';
                        const text = isPositive ? 'is owed' : 'owes';
                        const amountDisplay = formatCurrency(Math.abs(person.balance));
                        return `<div class="debt-item">
                            <div class="debt-item-header">
                                <div class="debt-person">${person.name}</div>
                                <div class="debt-status ${status}">${text}</div>
                            </div>
                            <div class="debt-amount ${isPositive ? 'positive' : 'negative'}">
                                ${amountDisplay}
                            </div>
                        </div>`;
                    });

                const totalAmount = Object.values(balances)
                    .filter(person => person.balance < 0)
                    .reduce((sum, person) => sum + Math.abs(person.balance), 0);

                if (totalDebtAmountElement) {
                    totalDebtAmountElement.dataset.value = totalAmount;
                    totalDebtAmountElement.textContent = formatCurrency(totalAmount);
                }

                if (balancesDiv) {
                    if (balanceItems.length === 0) {
                        balancesDiv.innerHTML = '<div class="debt-item" style="text-align: center; padding: var(--space-8);"><div style="font-size: 3rem; margin-bottom: var(--space-4);">✅</div><div style="font-weight: 600; color: var(--apple-green);">Everyone is settled up!</div><div style="color: var(--label-secondary); margin-top: var(--space-2);">No outstanding debts</div></div>';
                    } else {
                        balancesDiv.innerHTML = balanceItems.join('');
                    }
                }

            } catch (error) {
                console.error('Error loading balances:', error);
            }
        }
        async function calculateSettlement() {
            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('group_id', currentGroup.id)
                    .eq('settled', false);

                if (error) throw error;

                // Calculate net balances
                const balances = {};
                groupMembers.forEach(member => {
                    balances[member.id] = 0;
                });

                transactions.forEach(transaction => {
                    balances[transaction.from_member_id] -= transaction.amount;
                    balances[transaction.to_member_id] += transaction.amount;
                });

                // Try to use Python API for advanced settlement calculation
                try {
                    const response = await fetch('/api/smart-settlement', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            balances: balances,
                            members: groupMembers
                        })
                    });

                    if (response.ok) {
                        const apiResult = await response.json();
                        currentSettlement = apiResult.settlements;
                        displaySettlementResult(apiResult.settlements, apiResult.optimization_info);
                        return;
                    }
                } catch (apiError) {
                    console.log('Python API unavailable, using JavaScript fallback');
                }

                // Fallback to JavaScript algorithm
                const settlements = calculateSettlementJS(balances);
                currentSettlement = settlements;
                displaySettlementResult(settlements);

            } catch (error) {
                console.error('Error calculating settlement:', error);
            }
        }

        function calculateSettlementJS(balances) {
            // JavaScript fallback algorithm
            const creditors = [];
            const debtors = [];

            Object.entries(balances).forEach(([personId, balance]) => {
                if (balance > 0.01) {
                    creditors.push({ id: parseInt(personId), amount: balance });
                } else if (balance < -0.01) {
                    debtors.push({ id: parseInt(personId), amount: -balance });
                }
            });

            const settlements = [];
            let i = 0, j = 0;

            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];
                
                const settleAmount = Math.min(creditor.amount, debtor.amount);
                
                const creditorName = groupMembers.find(m => m.id === creditor.id).username;
                const debtorName = groupMembers.find(m => m.id === debtor.id).username;
                
                settlements.push({
                    from: debtor.id,
                    to: creditor.id,
                    fromName: debtorName,
                    toName: creditorName,
                    amount: settleAmount
                });

                creditor.amount -= settleAmount;
                debtor.amount -= settleAmount;

                if (creditor.amount < 0.01) i++;
                if (debtor.amount < 0.01) j++;
            }

            return settlements;
        }

        function displaySettlementResult(settlements, optimizationInfo = null) {
            const resultDiv = document.getElementById('settlementResult');
            const actionsDiv = document.getElementById('settleActions');

            if (settlements.length === 0) {
                resultDiv.innerHTML = '<div class="settlement-card" style="text-align: center; padding: var(--space-8);"><div style="font-size: 3rem; margin-bottom: var(--space-4);">✅</div><div style="font-weight: 600; color: var(--apple-green);">Everyone is already settled up!</div><div style="color: var(--label-secondary); margin-top: var(--space-2);">No payments needed</div></div>';
                actionsDiv.classList.add('hidden');
            } else {
                let optimizationText = '';
                if (optimizationInfo) {
                    optimizationText = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${optimizationInfo.algorithm}</div>
                                <div class="stat-label">Algorithm Used</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${optimizationInfo.computation_time}ms</div>
                                <div class="stat-label">Optimization Time</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${optimizationInfo.efficiency_percentage}%</div>
                                <div class="stat-label">Efficiency Gain</div>
                            </div>
                        </div>
                    `;
                }

                const totalAmount = settlements.reduce((sum, s) => sum + s.amount, 0);
                const totalAmountDisplay = formatCurrency(totalAmount);
                const settlementHtml = `
                    <div class="settlement-card">
                        <div class="settlement-header">
                            <div class="settlement-title">🧮 Smart Settlement Calculated!</div>
                            <div class="settlement-amount">${totalAmountDisplay}</div>
                        </div>
                        <div style="color: var(--label-secondary); margin-bottom: var(--space-4);">
                            Follow these steps to settle up with minimum transactions:
                        </div>
                        ${optimizationText}
                        <div class="settlement-steps">
                            ${settlements.map((s, index) => `
                                <div class="settlement-step">
                                    <div class="step-number">${index + 1}</div>
                                    <div class="step-details">
                                        <span class="step-from">${s.fromName}</span>
                                        <span> pays </span>
                                        <span class="step-to">${s.toName}</span>
                                        <span class="step-amount">${formatCurrency(s.amount)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = settlementHtml;
                actionsDiv.classList.remove('hidden');
            }
        }

        async function executeSettlement() {
            if (!currentSettlement || currentSettlement.length === 0) return;

            try {
                // Mark all current transactions as settled
                const { error: updateError } = await supabase
                    .from('transactions')
                    .update({ settled: true })
                    .eq('group_id', currentGroup.id)
                    .eq('settled', false);

                if (updateError) throw updateError;

                // Create settlement record
                const { error: settlementError } = await supabase
                    .from('settlements')
                    .insert([{
                        group_id: currentGroup.id,
                        settlement_data: currentSettlement,
                        created_by: currentUser.id
                    }]);

                if (settlementError) throw settlementError;

                alert('Settlement recorded successfully!');
                
                // Refresh views
                loadCurrentBalances();
                loadHistory();
                
                // Clear settlement
                currentSettlement = null;
                document.getElementById('settlementResult').innerHTML = '';
                document.getElementById('settleActions').classList.add('hidden');

            } catch (error) {
                alert('Error recording settlement: ' + error.message);
            }
        }

        async function loadHistory() {
            try {
                const { data: settlements, error } = await supabase
                    .from('settlements')
                    .select(`
                        *,
                        created_by_member:group_members!created_by(username)
                    `)
                    .eq('group_id', currentGroup.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const historyDiv = document.getElementById('historyList');
                
                if (settlements.length === 0) {
                    historyDiv.innerHTML = '<div class="history-item">No settlement history yet.</div>';
                    return;
                }

                const historyHtml = settlements.map(settlement => {
                    const date = new Date(settlement.created_at).toLocaleString();
                    const settlementsHtml = settlement.settlement_data.map(s =>
                        `<div style="margin: 4px 0;"><strong>${s.fromName}</strong> → <strong>${s.toName}</strong>: ${formatCurrency(s.amount)}</div>`
                    ).join('');
                    
                    return `<div class="history-item">
                        <div class="history-date">Settled on ${date} by ${settlement.created_by_member.username}</div>
                        ${settlementsHtml}
                    </div>`;
                }).join('');

                historyDiv.innerHTML = historyHtml;

            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function populateGroupSettings() {
            const nameInput = document.getElementById('groupNameInput');
            const currencySelect = document.getElementById('groupCurrencySelect');
            const adminNote = document.getElementById('groupSettingsAdminNote');
            const saveButton = document.getElementById('saveGroupSettingsBtn');

            if (!nameInput || !currencySelect) {
                return;
            }

            const currentCurrency = getCurrentCurrency();

            nameInput.value = currentGroup && currentGroup.name ? currentGroup.name : '';

            const hasCurrencyOption = Array.from(currencySelect.options).some(option => option.value === currentCurrency);
            if (!hasCurrencyOption) {
                const option = document.createElement('option');
                option.value = currentCurrency;
                option.textContent = `${currentCurrency}`;
                currencySelect.appendChild(option);
            }
            currencySelect.value = currentCurrency;

            const isAdmin = currentUser && currentUser.is_admin;
            nameInput.disabled = !isAdmin;
            currencySelect.disabled = !isAdmin;

            if (saveButton) {
                saveButton.disabled = !isAdmin;
            }

            if (adminNote) {
                adminNote.classList.toggle('hidden', !!isAdmin);
            }
        }

        function updateManageTab() {
            populateGroupSettings();
            const currentMembersDiv = document.getElementById('currentMembers');

            if (groupMembers.length === 0) {
                currentMembersDiv.innerHTML = `
                    <div style="text-align: center; padding: var(--space-8); color: var(--gray-500);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-4);">👥</div>
                        <p>No members found</p>
                    </div>
                `;
                return;
            }
            
            const membersHtml = groupMembers.map(member => {
                const canRemove = currentUser.is_admin && member.id !== currentUser.id;
                const isCurrentUser = member.id === currentUser.id;
                const roleClass = member.is_admin ? 'admin' : 'member';
                const roleText = member.is_admin ? 'Admin' : 'Member';
                
                return `<div class="transaction-item">
                    <div class="member-info">
                        <div class="member-avatar">
                            ${member.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="member-details">
                            <div class="member-name">
                                ${member.username} ${isCurrentUser ? '(You)' : ''}
                            </div>
                            <div class="member-role ${roleClass}">
                                ${roleText}
                            </div>
                        </div>
                    </div>
                    ${canRemove ? `<button class="btn btn-danger" onclick="removeMemberFromGroup(${member.id})" style="padding: var(--space-2) var(--space-3); font-size: 0.75rem;">Remove</button>` : ''}
                </div>`;
            }).join('');

            currentMembersDiv.innerHTML = membersHtml;
        }

        async function saveGroupSettings() {
            const errorDiv = document.getElementById('settingsError');
            const successDiv = document.getElementById('settingsSuccess');
            const nameInput = document.getElementById('groupNameInput');
            const currencySelect = document.getElementById('groupCurrencySelect');

            if (!nameInput || !currencySelect) {
                return;
            }

            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (!currentUser || !currentUser.is_admin) {
                errorDiv.textContent = 'Only admins can update group settings.';
                return;
            }

            const groupName = nameInput.value.trim();
            const currency = currencySelect.value;

            if (groupName.length < 2) {
                errorDiv.textContent = 'Group name must be at least 2 characters long.';
                return;
            }

            try {
                const { data: updatedGroup, error } = await supabase
                    .from('groups')
                    .update({
                        name: groupName,
                        currency: currency
                    })
                    .eq('id', currentGroup.id)
                    .select()
                    .single();

                if (error) throw error;

                currentGroup = { ...currentGroup, ...updatedGroup };

                successDiv.textContent = 'Group settings updated successfully!';
                populateGroupSettings();
                updateCurrencyDisplay();
                loadDashboard();
                loadCurrentBalances();
                loadHistory();

                setTimeout(() => {
                    successDiv.textContent = '';
                }, 3000);
            } catch (error) {
                errorDiv.textContent = 'Error updating settings: ' + error.message;
            }
        }

        async function addNewMember() {
            const memberName = document.getElementById('newMemberName').value.trim();
            const errorDiv = document.getElementById('manageError');
            const successDiv = document.getElementById('manageSuccess');
            
            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (!memberName) {
                errorDiv.textContent = 'Please enter a member name';
                return;
            }
            
            if (memberName.length < 2) {
                errorDiv.textContent = 'Member name must be at least 2 characters long';
                return;
            }

            if (groupMembers.some(member => member.username.toLowerCase() === memberName.toLowerCase())) {
                errorDiv.textContent = 'Member with this name already exists';
                return;
            }

            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                const { data, error } = await supabase
                    .from('group_members')
                    .insert([{
                        group_id: currentGroup.id,
                        username: memberName,
                        is_admin: false
                    }])
                    .select();

                if (error) throw error;

                groupMembers.push(data[0]);
                updateDropdowns();
                updateManageTab();
                
                document.getElementById('newMemberName').value = '';
                successDiv.textContent = `✅ ${memberName} added successfully!`;
                
                // Clear success message after 3 seconds
                setTimeout(() => {
                    successDiv.textContent = '';
                }, 3000);

            } catch (error) {
                errorDiv.textContent = 'Error adding member: ' + error.message;
            }
        }

        async function removeMemberFromGroup(memberId) {
            if (!currentUser.is_admin) {
                alert('Only admins can remove members');
                return;
            }

            if (!confirm('Are you sure you want to remove this member?')) {
                return;
            }

            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                const { error } = await supabase
                    .from('group_members')
                    .delete()
                    .eq('id', memberId);

                if (error) throw error;

                groupMembers = groupMembers.filter(member => member.id !== memberId);
                updateDropdowns();
                updateManageTab();
                
                document.getElementById('manageSuccess').textContent = 'Member removed successfully!';

            } catch (error) {
                document.getElementById('manageError').textContent = 'Error removing member: ' + error.message;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RoomLedger initialized');
            
            // Add a test button for debugging
            const testButton = document.createElement('button');
            testButton.textContent = 'Test App Section';
            testButton.style.position = 'fixed';
            testButton.style.top = '10px';
            testButton.style.right = '10px';
            testButton.style.zIndex = '9999';
            testButton.style.padding = '10px';
            testButton.style.background = '#000';
            testButton.style.color = '#fff';
            testButton.style.border = 'none';
            testButton.style.borderRadius = '5px';
            testButton.onclick = function() {
                console.log('Testing app section visibility...');
                const appSection = document.getElementById('appSection');
                const authSection = document.getElementById('authSection');
                console.log('App section:', appSection);
                console.log('Auth section:', authSection);
                console.log('App section classes:', appSection ? appSection.className : 'not found');
                console.log('Auth section classes:', authSection ? authSection.className : 'not found');
                
                // Force show app section for testing
                if (appSection) {
                    appSection.classList.remove('hidden');
                    appSection.style.display = 'block';
                }
                if (authSection) {
                    authSection.classList.add('hidden');
                    authSection.style.display = 'none';
                }
            };
            document.body.appendChild(testButton);
        });
    </script>
</body>
</html>